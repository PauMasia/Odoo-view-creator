<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Generador de XPaths Odoo</title>

<!-- CSS extra externo (cambiable desde el selector) -->
<link id="extraCss" rel="stylesheet" href="">

<style>
:root {
    --bg-body: #f3f4f6;
    --bg-main: #ffffff;
    --bg-block: #e0edff;
    --border-soft: #d1d5db;
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --text-main: #111827;
    --text-muted: #6b7280;
    --shadow-soft: 0 8px 20px rgba(15, 23, 42, 0.1);
    --danger-bg: #fee2e2;
    --danger-border: #dc2626;
    --danger-text: #991b1b;
}

/* Modo oscuro: sobreescribe variables */
body.dark-mode {
    --bg-body: #020617;
    --bg-main: #020617;
    --bg-block: #111827;
    --border-soft: #1f2937;
    --primary: #3b82f6;
    --primary-dark: #1d4ed8;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --danger-bg: #7f1d1d;
    --danger-border: #fca5a5;
    --danger-text: #fee2e2;
}

* {
    box-sizing: border-box;
}

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 24px;
    background: var(--bg-body);
    color: var(--text-main);
}

/* TOP BAR */
.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.top-bar h1 {
    font-size: 22px;
    margin: 0;
}

.top-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
}

.top-toggle-label {
    display: flex;
    align-items: center;
    gap: 6px;
}

.top-controls select {
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #ffffff;
    font-size: 13px;
}

/* Banner aviso variables */
.variables-warning {
    margin-bottom: 16px;
    padding: 8px 10px;
    border-radius: 10px;
    background: #e5e7eb;
    color: #374151;
    font-size: 12px;
    border: 1px dashed #9ca3af;
}

/* LAYOUT PRINCIPAL: DOS COLUMNAS */
.layout {
    display: flex;
    gap: 24px;
    align-items: flex-start;
}

.column {
    flex: 1;
}

/* Tarjeta izquierda (configuraci√≥n) */
.config-card {
    background: var(--bg-main);
    border-radius: 16px;
    padding: 18px 20px;
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-soft);
}

/* Alerta de m√≥dulo */
.module-alert {
    display: none;
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 12px;
    margin-bottom: 10px;
}

/* Caja de error */
.error-box {
    display: none;
    background: var(--danger-bg);
    border: 1px solid var(--danger-border);
    color: var(--danger-text);
    padding: 8px 10px;
    border-radius: 10px;
    font-size: 12px;
    margin-bottom: 10px;
}

/* Derecha: contenedor de bloques */
.blocks-wrapper {
    background: transparent;
}

/* LABELS + CONTROLES */
h2 {
    font-size: 18px;
    margin: 0 0 10px 0;
}

label {
    font-weight: 600;
    font-size: 13px;
    display: block;
    margin-bottom: 4px;
}

.sub-label {
    font-weight: 500;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
    margin-bottom: 4px;
}

input[type="text"],
textarea,
input[type="number"],
select {
    width: 100%;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid var(--border-soft);
    background: #ffffff;
    font-size: 14px;
    color: var(--text-main);
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
    margin-bottom: 10px;
}

input[type="text"]:focus,
textarea:focus,
input[type="number"]:focus,
select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
}

textarea {
    resize: vertical;
    min-height: 80px;
}

/* Campo peque√±o para n√∫mero de l√≠nea */
.lineNumber {
    max-width: 70px;
}

/* Quitar flechas number */
.lineNumber::-webkit-outer-spin-button,
.lineNumber::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.lineNumber {
    -moz-appearance: textfield;
}

/* CHECKBOXES */
input[type="checkbox"] {
    width: auto;
    margin: 0;
    transform: scale(1.1);
}

/* Grupo deshabilitado */
.disabledArea {
    position: relative;
    opacity: 0.4;
    filter: grayscale(60%);
    pointer-events: none;
}

/* TIPO DE VISTA: BOTONES */
.type-btns {
    display: flex;
    gap: 8px;
    margin-top: 6px;
    margin-bottom: 4px;
}

.type-btns button {
    flex: 0 0 auto;
}

/* BOTONES GEN√âRICOS */
button {
    padding: 9px 14px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #ffffff;
    color: var(--text-main);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
}

button:hover {
    background: #e5e7eb;
    box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
    transform: translateY(-1px);
}

button:active {
    transform: translateY(0);
    box-shadow: none;
}

.type-btns button.active {
    background: var(--primary);
    color: #ffffff;
    border-color: var(--primary-dark);
}

.btn-primary {
    background: var(--primary);
    color: #ffffff;
    border-color: var(--primary-dark);
}
.btn-primary:hover {
    background: var(--primary-dark);
}

.btn-ghost {
    background: transparent;
    border-color: transparent;
    color: var(--text-muted);
}
.btn-ghost:hover {
    background: #e5e7eb;
    border-color: #d1d5db;
}

/* XML grande */
#xmlOriginal {
    font-family: "JetBrains Mono", Consolas, monospace;
    min-height: 180px;
}

/* BLOQUES DERECHA */
#blocks {
    margin-top: 4px;
}

.block {
    background: var(--bg-block);
    border-radius: 16px;
    padding: 10px 12px 10px;
    margin-bottom: 14px;
    border: 1px solid rgba(37, 99, 235, 0.5);
    box-shadow: 0 4px 10px rgba(37, 99, 235, 0.12);
}

.block-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
}

.block-title {
    font-weight: 600;
    font-size: 13px;
}

.block-header-buttons {
    display: flex;
    gap: 6px;
}

.block-toggle-btn {
    border-radius: 50%;
    width: 28px;
    height: 28px;
    justify-content: center;
    padding: 0;
    font-size: 13px;
}

.block-body {
    margin-top: 8px;
}

.block.collapsed .block-body {
    display: none;
}

.block.collapsed .block-toggle-btn {
    transform: rotate(-90deg);
}

/* Lista de atributos */
.attrList {
    margin-bottom: 8px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    font-size: 12px;
}

.attrItem {
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: 6px;
}
.attrItem input[type="checkbox"] {
    transform: scale(1.0);
}

/* Encabezado derecha */
.right-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}

.right-header h2 {
    margin: 0;
    font-size: 18px;
}

/* Modal overlay */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal-hidden {
    display: none;
}

.modal-dialog {
    background: #ffffff;
    border-radius: 16px;
    padding: 16px 18px;
    max-width: 420px;
    width: 100%;
    box-shadow: 0 12px 40px rgba(15,23,42,0.4);
    border: 1px solid var(--border-soft);
}

.modal-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 6px;
}

.modal-message {
    font-size: 14px;
    color: var(--text-muted);
    margin-bottom: 12px;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* Texto modificable deshabilitado (ocultar) */
.modFrag:disabled {
    background: #e5e7eb;
    color: #9ca3af;
}

/* Espaciados peque√±os */
.mt-8 { margin-top: 8px; }
.mt-12 { margin-top: 12px; }
.mt-16 { margin-top: 16px; }
</style>
</head>

<body>

<div class="top-bar">
  <h1>Generador de XPaths para vistas Odoo</h1>
  <div class="top-controls">
    <label class="top-toggle-label">
      <input type="checkbox" id="darkModeToggle">
      <span>Modo oscuro</span>
    </label>
    <div>
      <span style="margin-right:4px;">CSS extra:</span>
      <select id="cssSelector"></select>
    </div>
  </div>
</div>

<div class="variables-warning">
    Aviso: revisa manualmente los XPaths generados cuando dependan de condiciones din√°micas o campos que puedan cambiar.
</div>

<!-- MODAL HTML (para confirmaciones) -->
<div id="modalOverlay" class="modal-overlay modal-hidden">
  <div class="modal-dialog">
    <div class="modal-title" id="modalTitle">Confirmar acci√≥n</div>
    <div class="modal-message" id="modalMessage"></div>
    <div class="modal-actions">
      <button type="button" onclick="handleModalCancel()">Cancelar</button>
      <button type="button" class="btn-primary" onclick="handleModalConfirm()">Aceptar</button>
    </div>
  </div>
</div>

<div class="layout">

    <!-- ================= COLUMNA IZQUIERDA: CONFIG ================= -->
    <div class="column">
        <div class="config-card">

            <!-- Caja de error -->
            <div id="errorBox" class="error-box"></div>

            <!-- Alerta del m√≥dulo -->
            <div id="moduleAlert" class="module-alert">
                Recuerda a√±adir el m√≥dulo <strong><span id="moduleAlertName"></span></strong> en
                <code>depends</code> del <code>__manifest__.py</code> para poder usar esta herencia.
            </div>

            <h2>Configuraci√≥n</h2>

            <!-- M√≥dulo -->
            <div class="mt-8">
                <label for="moduleName">M√≥dulo de la vista original</label>
                <input type="text" id="moduleName" placeholder="Ej: payment_custom o theme_prime"
                       oninput="updateModuleNotice()">
            </div>

            <!-- Nombre archivo salida -->
            <div class="mt-8">
                <label for="outputFilename">Nombre del archivo (opcional, por defecto views.xml)</label>
                <input type="text" id="outputFilename" placeholder="Ej: custom_views.xml">
            </div>

            <!-- TIPOS DE VISTA -->
            <div class="mt-16">
                <label>Tipo de vista</label>
                <div class="type-btns">
                    <button id="t-template" onclick="onTypeClick('template')">Template</button>
                    <button id="t-record" onclick="onTypeClick('record')">Records</button>
                    <button id="t-theme" onclick="onTypeClick('theme_prime')">Theme&nbsp;Prime</button>
                </div>
            </div>

            <!-- XML ORIGINAL -->
            <div class="mt-16">
                <label for="xmlOriginal">XML a modificar</label>
                <textarea id="xmlOriginal" placeholder="Pega aqu√≠ la vista XML original..."></textarea>
            </div>

            <!-- BOTONES ACCI√ìN -->
            <div class="mt-16" style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn-primary" onclick="addBlock()">+ A√±adir bloque</button>
                <button class="btn-ghost" onclick="downloadResults()">Descargar archivo</button>
            </div>
        </div>
    </div>

    <!-- ================= COLUMNA DERECHA: BLOQUES ================= -->
    <div class="column">
        <div class="blocks-wrapper">
            <div class="right-header">
                <h2>Bloques generados</h2>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn-ghost" onclick="copyAllXml()">Copiar c√≥digo</button>
                    <button type="button" class="btn-ghost" onclick="clearBlocksWithConfirm()">Limpiar bloques</button>
                </div>
            </div>
            <div id="blocks"></div>
        </div>
    </div>

</div>

<script>
let selectedType = null;
let currentModal = null; // { type: 'overwriteMod'|'deleteBlock'|'changeType'|'clearBlocks', ... }

/* ============================================
   CSS EXTRA + MODO OSCURO
   ============================================ */
const cssFiles = [
    { label: "Sin CSS extra", value: "" },
    // { label: "Tema corporativo", value: "css/tema_corporativo.css" },
];

function initCssSelector() {
    const select = document.getElementById("cssSelector");
    cssFiles.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.value;
        opt.textContent = f.label;
        select.appendChild(opt);
    });
    select.addEventListener("change", () => {
        const href = select.value;
        const link = document.getElementById("extraCss");
        link.href = href || "";
    });
}

function initDarkMode() {
    const toggle = document.getElementById("darkModeToggle");
    toggle.addEventListener("change", () => {
        document.body.classList.toggle("dark-mode", toggle.checked);
    });
}

window.addEventListener("DOMContentLoaded", () => {
    initCssSelector();
    initDarkMode();
});

/* ============================================
   UTILIDADES UI: ERRORES Y M√ìDALS
   ============================================ */
function showError(message) {
    const box = document.getElementById("errorBox");
    box.textContent = message;
    box.style.display = "block";
}

function clearError() {
    const box = document.getElementById("errorBox");
    box.textContent = "";
    box.style.display = "none";
}

function showModal(title, message, payload) {
    currentModal = payload || null;
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalMessage").textContent = message;
    document.getElementById("modalOverlay").classList.remove("modal-hidden");
}

function hideModal() {
    document.getElementById("modalOverlay").classList.add("modal-hidden");
    currentModal = null;
}

function handleModalConfirm() {
    if (!currentModal) {
        hideModal();
        return;
    }
    if (currentModal.type === "overwriteMod") {
        performGenerateXPath(currentModal.block);
    } else if (currentModal.type === "deleteBlock") {
        currentModal.block.remove();
        renumberBlocks();
    } else if (currentModal.type === "changeType") {
        clearAllBlocks();
        applyType(currentModal.newType);
    } else if (currentModal.type === "clearBlocks") {
        clearAllBlocks();
    }
    hideModal();
}

function handleModalCancel() {
    hideModal();
}

/* ============================================
   ALERTA DEL M√ìDULO (manifest)
   ============================================ */
function updateModuleNotice() {
    const mod = document.getElementById("moduleName").value.trim();
    const alertBox = document.getElementById("moduleAlert");
    const spanName = document.getElementById("moduleAlertName");

    if (mod) {
        alertBox.style.display = "block";
        spanName.textContent = mod;
    } else {
        alertBox.style.display = "none";
        spanName.textContent = "";
    }
}

/* ============================================
   SELECCI√ìN DE TIPO DE VISTA (con confirmaci√≥n)
   ============================================ */
function onTypeClick(type) {
    if (selectedType === type) {
        applyType(type);
        return;
    }
    const hasBlocks = document.querySelectorAll("#blocks .block").length > 0;
    if (hasBlocks) {
        showModal(
            "Cambiar tipo de vista",
            "Cambiar el tipo de vista borrar√° todos los bloques actuales. ¬øQuieres continuar?",
            { type: "changeType", newType: type }
        );
    } else {
        applyType(type);
    }
}

function applyType(type) {
    selectedType = type;
    document.querySelectorAll(".type-btns button")
        .forEach(b => b.classList.remove("active"));

    if (type === "template") document.getElementById("t-template").classList.add("active");
    if (type === "record") document.getElementById("t-record").classList.add("active");
    if (type === "theme_prime") document.getElementById("t-theme").classList.add("active");
}

/* ============================================
   BLOQUES: A√ëADIR / DUPLICAR / BORRAR
   ============================================ */
function addBlock() {
    const container = document.getElementById("blocks");
    const index = container.querySelectorAll(".block").length + 1;

    const div = document.createElement("div");
    div.className = "block";

    div.innerHTML = `
        <div class="block-header" onclick="toggleBlock(this)">
            <span class="block-title">Bloque ${index}</span>
            <div class="block-header-buttons">
                <button type="button" class="block-toggle-btn" onclick="toggleBlock(this); event.stopPropagation();">‚ñæ</button>
                <button type="button" title="Copiar bloque" onclick="copyBlockXml(this); event.stopPropagation();">üìã</button>
                <button type="button" title="Duplicar bloque" onclick="duplicateBlock(this); event.stopPropagation();">‚ßâ</button>
                <button type="button" title="Eliminar bloque" onclick="deleteBlock(this); event.stopPropagation();">üóë</button>
            </div>
        </div>
        <div class="block-body">
            <label>Nombre del bloque (solo visual)</label>
            <input type="text" class="blockLabel" placeholder="Ej: Ocultar mensaje, A√±adir bot√≥n..." oninput="updateBlockTitle(this)">

            <label>Nombre de la vista (este bloque)</label>
            <input type="text" class="blockViewName" placeholder="Ej: payment_transaction_status">

            <label>Funcionalidad (opcional para este bloque)</label>
            <input type="text" class="blockFunc" placeholder="Ej: custom">

            <label>Acci√≥n:</label>
            <select class="actionType" onchange="onActionTypeChange(this)">
                <option value="add">A√±adir contenido</option>
                <option value="hide">Ocultar elemento (placeholder)</option>
            </select>

            <label>Fragmento a localizar (etiqueta completa):</label>
            <textarea class="frag" rows="3" placeholder="Ej: &lt;div t-if=&quot;...&quot; id=&quot;o_payment_status_message&quot; class=&quot;...&quot;&gt;"></textarea>

            <label>N√∫mero de l√≠nea desde donde buscar:</label>
            <input type="number" class="lineNumber" min="1" placeholder="32">

            <label>Atributos a usar en el XPath (marca/desmarca):</label>
            <div class="attrList"></div>

            <label>Texto modificable (se rellenar√° con el fragmento encontrado):</label>
            <textarea class="modFrag" rows="3"></textarea>

            <label>XPath generado (puedes ajustarlo a mano):</label>
            <textarea class="xpath" rows="2"></textarea>

            <button type="button" onclick="generateXPath(this)">Generar XPath</button>
        </div>
    `;

    container.appendChild(div);
    renumberBlocks();

    const actionSel = div.querySelector(".actionType");
    onActionTypeChange(actionSel);
}

function renumberBlocks() {
    const blocks = document.querySelectorAll("#blocks .block");
    blocks.forEach((b, i) => {
        const title = b.querySelector(".block-title");
        const label = b.querySelector(".blockLabel")?.value.trim();
        if (label) {
            title.textContent = `Bloque ${i + 1} ‚Äî ${label}`;
        } else {
            title.textContent = `Bloque ${i + 1}`;
        }
    });
}

function updateBlockTitle(input) {
    const block = input.closest(".block");
    const blocks = Array.from(document.querySelectorAll("#blocks .block"));
    const idx = blocks.indexOf(block);
    const title = block.querySelector(".block-title");
    const label = input.value.trim();
    if (label) {
        title.textContent = `Bloque ${idx + 1} ‚Äî ${label}`;
    } else {
        title.textContent = `Bloque ${idx + 1}`;
    }
}

function onActionTypeChange(sel) {
    const block = sel.closest(".block");
    if (!block) return;
    const modArea = block.querySelector(".modFrag");
    if (sel.value === "hide") {
        modArea.value = "";
        modArea.disabled = true;
        if (!modArea.dataset.originalPlaceholder) {
            modArea.dataset.originalPlaceholder = modArea.placeholder || "";
        }
        modArea.placeholder = "No se a√±ade contenido cuando se oculta.";
    } else {
        modArea.disabled = false;
        modArea.placeholder = modArea.dataset.originalPlaceholder || "";
    }
}

function duplicateBlock(btn) {
    const block = btn.closest(".block");
    if (!block) return;

    const label = block.querySelector(".blockLabel").value;
    const viewName = block.querySelector(".blockViewName").value;
    const func = block.querySelector(".blockFunc").value;
    const frag = block.querySelector(".frag").value;
    const lineNumber = block.querySelector(".lineNumber").value;
    const modFrag = block.querySelector(".modFrag").value;
    const xpath = block.querySelector(".xpath").value;
    const actionType = block.querySelector(".actionType").value;

    addBlock();
    const blocks = document.querySelectorAll(".block");
    const newBlock = blocks[blocks.length - 1];

    newBlock.querySelector(".blockLabel").value = label;
    newBlock.querySelector(".blockViewName").value = viewName;
    newBlock.querySelector(".blockFunc").value = func;
    newBlock.querySelector(".frag").value = frag;
    newBlock.querySelector(".lineNumber").value = lineNumber;
    newBlock.querySelector(".modFrag").value = modFrag;
    newBlock.querySelector(".xpath").value = xpath;
    newBlock.querySelector(".actionType").value = actionType;
    onActionTypeChange(newBlock.querySelector(".actionType"));
    updateBlockTitle(newBlock.querySelector(".blockLabel"));
}

function deleteBlock(btn) {
    const block = btn.closest(".block");
    if (!block) return;

    const hasContent =
        block.querySelector(".frag").value.trim() !== "" ||
        block.querySelector(".modFrag").value.trim() !== "" ||
        block.querySelector(".xpath").value.trim() !== "" ||
        block.querySelector(".blockViewName").value.trim() !== "" ||
        block.querySelector(".blockFunc").value.trim() !== "" ||
        block.querySelector(".blockLabel").value.trim() !== "";

    if (hasContent) {
        showModal(
            "Eliminar bloque",
            "Este bloque contiene informaci√≥n. Si contin√∫as, se eliminar√° definitivamente.",
            { type: "deleteBlock", block }
        );
    } else {
        block.remove();
        renumberBlocks();
    }
}

function clearAllBlocks() {
    const container = document.getElementById("blocks");
    container.innerHTML = "";
}

function clearBlocksWithConfirm() {
    const hasBlocks = document.querySelectorAll("#blocks .block").length > 0;
    if (!hasBlocks) return;
    showModal(
        "Limpiar bloques",
        "Se eliminar√°n todos los bloques y su contenido. ¬øQuieres continuar?",
        { type: "clearBlocks" }
    );
}

/* ============================================
   COPIAR TEXTO GENERICAMENTE
   ============================================ */
async function copyTextToClipboard(text) {
    try {
        if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
        } else {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
        }
    } catch (e) {
        console.error("Error copiando al portapapeles", e);
    }
}

/* ============================================
   COPIAR XML COMPLETO / BLOQUE
   ============================================ */
async function copyAllXml() {
    clearError();

    if (!selectedType) {
        showError("Debes seleccionar un tipo de vista (Template, Records o Theme Prime).");
        return;
    }

    const xmlOriginal = document.getElementById("xmlOriginal").value;
    const moduleName = document.getElementById("moduleName").value.trim();

    if (!moduleName) {
        showError("El campo 'M√≥dulo de la vista original' es obligatorio.");
        return;
    }
    if (!xmlOriginal.trim()) {
        showError("Debes pegar el XML original de la vista.");
        return;
    }

    const blocks = collectBlocks();
    if (!blocks.length) {
        showError("Debes crear al menos un bloque.");
        return;
    }

    const missingBlock = blocks.find(b => !b.viewName);
    if (missingBlock) {
        const label = missingBlock.label ? ` (${missingBlock.label})` : "";
        showError(
            `El bloque ${missingBlock.index}${label} no tiene 'Nombre de la vista (este bloque)'. ` +
            `Se autocompleta al generar XPath si se puede, o rell√©nalo a mano.`
        );
        return;
    }

    const meta = {
        selectedType,
        xmlOriginal,
        moduleName
    };

    const txt = buildOutput(blocks, meta);
    await copyTextToClipboard(txt);
}

async function copyBlockXml(btn) {
    clearError();

    if (!selectedType) {
        showError("Debes seleccionar un tipo de vista (Template, Records o Theme Prime).");
        return;
    }

    const xmlOriginal = document.getElementById("xmlOriginal").value;
    const moduleName = document.getElementById("moduleName").value.trim();

    if (!xmlOriginal.trim()) {
        showError("Debes pegar el XML original de la vista.");
        return;
    }
    if (!moduleName) {
        showError("El campo 'M√≥dulo de la vista original' es obligatorio.");
        return;
    }

    const blockElem = btn.closest(".block");
    const blockElems = Array.from(document.querySelectorAll("#blocks .block"));
    const idx = blockElems.indexOf(blockElem);
    if (idx === -1) return;

    const blocks = collectBlocks();
    const b = blocks[idx];

    if (!b.viewName) {
        const label = b.label ? ` (${b.label})` : "";
        showError(
            `El bloque ${b.index}${label} necesita 'Nombre de la vista (este bloque)'. ` +
            `Pulsa 'Generar XPath' para intentar autocompletarlo o rell√©nalo manualmente.`
        );
        return;
    }

    const meta = {
        selectedType,
        xmlOriginal,
        moduleName
    };
    const xmlLines = xmlOriginal.split("\n");

    let inner = "";
    if (selectedType === "record") {
        inner = buildRecordBlockXml(b, meta, xmlLines);
    } else if (selectedType === "template") {
        inner = buildTemplateBlockXml(b, meta, xmlLines);
    } else if (selectedType === "theme_prime") {
        inner = buildThemePrimeBlockXml(b, meta, xmlLines);
    } else {
        inner = buildGenericBlockXml(b);
    }

    const txt = "<odoo>\n" + inner + "\n</odoo>\n";
    await copyTextToClipboard(txt);
}

/* ============================================
   COLAPSAR / EXPANDIR BLOQUE
   ============================================ */
function toggleBlock(el) {
    const block = el.closest(".block");
    if (!block) return;
    block.classList.toggle("collapsed");
}

/* ============================================
   PARSEAR ETIQUETA + ATRIBUTOS A OBJETO
   ============================================ */
function parseTagAndAttrs(fragment) {
    const match = fragment.match(/<(\w+)([\s\S]*?)>/);
    if (!match) return null;
    const tag = match[1];
    const attrsStr = match[2] || "";
    const attrs = [];
    const attrRegex = /([^\s=]+)=["']([^"']+)["']/g;
    let m;
    while ((m = attrRegex.exec(attrsStr)) !== null) {
        attrs.push({ name: m[1], value: m[2] });
    }
    return { tag, attrs };
}

function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

/* ============================================
   BUSCAR EN EL XML UN TAG POR ATRIBUTOS
   ============================================ */
function findTagInXmlByAttrs(tagInfo, xmlLines, startLine) {
    const tag = tagInfo.tag;
    const attrs = tagInfo.attrs || [];
    const n = xmlLines.length;

    function matchesSnippet(snippet) {
        for (const a of attrs) {
            const pattern = new RegExp(a.name + "\\s*=\\s*[\"']" + escapeRegex(a.value) + "[\"']");
            if (!pattern.test(snippet)) {
                return false;
            }
        }
        return true;
    }

    function scan(from) {
        for (let i = from; i < n; i++) {
            if (xmlLines[i].includes("<" + tag)) {
                let snippetLines = [xmlLines[i]];
                let j = i;
                while (j < n && !xmlLines[j].includes(">")) {
                    j++;
                    if (j < n) snippetLines.push(xmlLines[j]);
                }
                const snippet = snippetLines.join("\n");
                if (matchesSnippet(snippet)) {
                    return { snippet, startIndex: i };
                }
            }
        }
        return null;
    }

    const startIdx = Math.max(0, (startLine || 1) - 1);
    let res = scan(startIdx);
    if (!res) res = scan(0);
    return res;
}

/* ============================================
   ENCONTRAR PADRE DEL TAG
   ============================================ */
function findParentTagForLine(xmlLines, childStartIndex) {
    for (let i = childStartIndex - 1; i >= 0; i--) {
        const line = xmlLines[i];
        const m = line.match(/<(\w+)([^>]*?)>/);
        if (m && !line.includes("</")) {
            const tag = m[1];
            const attrsStr = m[2] || "";
            const attrs = [];
            const attrRegex = /([^\s=]+)=["']([^"']+)["']/g;
            let a;
            while ((a = attrRegex.exec(attrsStr)) !== null) {
                attrs.push({ name: a[1], value: a[2] });
            }
            return { tag, attrs };
        }
    }
    return null;
}

/* ============================================
   GENERAR XPATH (usa modal si va a sobrescribir)
   ============================================ */
function generateXPath(btn) {
    const block = btn.closest(".block");
    const modArea = block.querySelector(".modFrag");

    if (modArea.value.trim() !== "" && !modArea.disabled) {
        showModal(
            "Sobrescribir contenido",
            "Este bloque ya tiene contenido en el √°rea de modificaci√≥n. Si generas el XPath, se sobrescribir√° con el fragmento encontrado. ¬øQuieres continuar?",
            { type: "overwriteMod", block }
        );
    } else {
        performGenerateXPath(block);
    }
}

/* ============================================
   L√ìGICA REAL DE GENERACI√ìN DE XPATH
   ============================================ */
function performGenerateXPath(block) {
    const xmlText = document.getElementById("xmlOriginal").value;
    const xmlLines = xmlText.split("\n");

    const fragment = block.querySelector(".frag").value.trim();
    const startLine = parseInt(block.querySelector(".lineNumber").value) || 1;
    const modArea = block.querySelector(".modFrag");
    const attrContainer = block.querySelector(".attrList");
    const xpathArea = block.querySelector(".xpath");
    const blockViewInput = block.querySelector(".blockViewName");

    if (!fragment || !xmlText.trim()) {
        xpathArea.value = "Error: falta fragmento o XML";
        return;
    }

    const tagInfo = parseTagAndAttrs(fragment);
    if (!tagInfo) {
        xpathArea.value = "Error: no se pudo interpretar la etiqueta";
        return;
    }

    const found = findTagInXmlByAttrs(tagInfo, xmlLines, startLine);
    if (!found) {
        xpathArea.value = "No se encontr√≥ un tag con esos atributos a partir de esa l√≠nea";
        attrContainer.innerHTML = "";
        tagInfo.attrs.forEach(a => {
            const item = document.createElement("label");
            item.className = "attrItem";
            item.innerHTML = `
                <input type="checkbox" class="attrCheck" data-name="${a.name}" data-value="${a.value}" checked>
                <span>${a.name}="${a.value}"</span>
            `;
            attrContainer.appendChild(item);
        });
        attrContainer.querySelectorAll(".attrCheck").forEach(ch => {
            ch.addEventListener("change", () => updateXPathForAttrSelection(block));
        });
        return;
    }

    block.dataset.foundStartIndex = found.startIndex;

    // Autocompletar nombre de vista seg√∫n el padre (record/template/theme_prime usa template)
    if (!blockViewInput.value.trim()) {
        if (selectedType === "record") {
            const tempBlock = { fragment, lineNumber: startLine };
            const info = findRecordMetaForBlock(tempBlock, xmlLines);
            if (info && info.recId) {
                blockViewInput.value = info.recId;
            }
        } else if (selectedType === "template" || selectedType === "theme_prime") {
            const tempBlock = { fragment, lineNumber: startLine };
            const info = findTemplateMetaForBlock(tempBlock, xmlLines);
            if (info && info.templateId) {
                blockViewInput.value = info.templateId;
            }
        }
    }

    if (!modArea.disabled) {
        modArea.value = found.snippet.trim();
    }

    attrContainer.innerHTML = "";
    tagInfo.attrs.forEach(a => {
        const item = document.createElement("label");
        item.className = "attrItem";
        item.innerHTML = `
            <input type="checkbox" class="attrCheck" data-name="${a.name}" data-value="${a.value}" checked>
            <span>${a.name}="${a.value}"</span>
        `;
        attrContainer.appendChild(item);
    });

    attrContainer.querySelectorAll(".attrCheck").forEach(ch => {
        ch.addEventListener("change", () => updateXPathForAttrSelection(block));
    });

    xpathArea.value = buildXPathFromSelection(block, tagInfo, xmlLines, found.startIndex);
}

/* ============================================
   RECONSTRUIR XPATH AL CAMBIAR CHECKBOXES
   ============================================ */
function updateXPathForAttrSelection(block) {
    const xmlText = document.getElementById("xmlOriginal").value;
    const xmlLines = xmlText.split("\n");
    const fragment = block.querySelector(".frag").value.trim();
    const startLine = parseInt(block.querySelector(".lineNumber").value) || 1;

    if (!fragment || !xmlText.trim()) return;
    const tagInfo = parseTagAndAttrs(fragment);
    if (!tagInfo) return;

    const found = findTagInXmlByAttrs(tagInfo, xmlLines, startLine);
    const startIndex = found ? found.startIndex : (parseInt(block.dataset.foundStartIndex) || 0);

    const xpath = buildXPathFromSelection(block, tagInfo, xmlLines, startIndex);
    block.querySelector(".xpath").value = xpath;
}

/* ============================================
   CONSTRUIR XPATH EN BASE A ATRIBUTOS SELECCIONADOS
   ============================================ */
function buildXPathFromSelection(block, tagInfo, xmlLines, startIndex) {
    const attrContainer = block.querySelector(".attrList");
    const checks = attrContainer.querySelectorAll(".attrCheck");
    const condParts = [];

    checks.forEach(ch => {
        if (ch.checked) {
            const name = ch.getAttribute("data-name");
            const value = ch.getAttribute("data-value");
            condParts.push(`@${name}='${value}'`);
        }
    });

    if (!condParts.length && tagInfo.attrs.length) {
        tagInfo.attrs.forEach(a => {
            condParts.push(`@${a.name}='${a.value}'`);
        });
    }

    let childExpr = `${tagInfo.tag}`;
    if (condParts.length) {
        childExpr += `[${condParts.join(" and ")}]`;
    }

    let xpath;
    if (Number.isInteger(startIndex) && startIndex >= 0) {
        const parentInfo = findParentTagForLine(xmlLines, startIndex);
        if (parentInfo && parentInfo.tag !== "xpath") {
            const parentCondParts = [];
            parentInfo.attrs.forEach(a => {
                if (a.name === "id" || a.name === "class" || a.name === "name") {
                    parentCondParts.push(`@${a.name}='${a.value}'`);
                }
            });
            let parentExpr = parentInfo.tag;
            if (parentCondParts.length) {
                parentExpr += `[${parentCondParts.join(" and ")}]`;
            }
            xpath = `//${parentExpr}//${childExpr}`;
        } else {
            xpath = `//${childExpr}`;
        }
    } else {
        xpath = `//${childExpr}`;
    }

    return xpath;
}

/* ============================================
   RECOGER DATOS DE BLOQUES
   ============================================ */
function collectBlocks() {
    const blocks = [];
    document.querySelectorAll("#blocks .block").forEach((b, idx) => {
        blocks.push({
            index: idx + 1,
            label: b.querySelector(".blockLabel").value.trim(),
            viewName: b.querySelector(".blockViewName").value.trim(),
            func: b.querySelector(".blockFunc").value.trim(),
            actionType: b.querySelector(".actionType").value,
            fragment: b.querySelector(".frag").value,
            xpath: b.querySelector(".xpath").value,
            modification: b.querySelector(".modFrag").value,
            lineNumber: parseInt(b.querySelector(".lineNumber").value) || 1
        });
    });
    return blocks;
}

/* ============================================
   HELPER: RECORD META
   ============================================ */
function findRecordMetaForBlock(block, xmlLines) {
    const tagInfo = parseTagAndAttrs(block.fragment || "");
    if (!tagInfo) return null;
    const found = findTagInXmlByAttrs(tagInfo, xmlLines, block.lineNumber || 1);
    if (!found) return null;

    const startLineIndex = found.startIndex;

    let recStart = -1;
    for (let i = startLineIndex; i >= 0; i--) {
        if (xmlLines[i].includes("<record")) {
            recStart = i;
            break;
        }
    }
    if (recStart === -1) return null;

    const recLine = xmlLines[recStart];
    const recMatch = recLine.match(/<record[^>]*id=["']([^"']+)["'][^>]*model=["']([^"']+)["']?/);
    const recId = recMatch ? recMatch[1] : null;
    const recModel = recMatch ? recMatch[2] : null;

    let underlyingModel = null;
    for (let i = recStart; i < xmlLines.length; i++) {
        const line = xmlLines[i];
        if (line.includes("</record>")) break;
        const modelMatch = line.match(/<field[^>]*name=["']model["'][^>]*>([^<]+)<\/field>/);
        if (modelMatch && !underlyingModel) {
            underlyingModel = modelMatch[1].trim();
        }
    }

    return { recId, recModel, underlyingModel };
}

/* ============================================
   HELPER: TEMPLATE META
   ============================================ */
function findTemplateMetaForBlock(block, xmlLines) {
    const tagInfo = parseTagAndAttrs(block.fragment || "");
    if (!tagInfo) return null;
    const found = findTagInXmlByAttrs(tagInfo, xmlLines, block.lineNumber || 1);
    if (!found) return null;

    const startLineIndex = found.startIndex;

    let tmplStart = -1;
    for (let i = startLineIndex; i >= 0; i--) {
        if (xmlLines[i].includes("<template")) {
            tmplStart = i;
            break;
        }
    }
    if (tmplStart === -1) return null;

    const tmplLine = xmlLines[tmplStart];
    const tmplMatch = tmplLine.match(/<template[^>]*id=["']([^"']+)["'][^>]*>/);
    const templateId = tmplMatch ? tmplMatch[1] : null;

    return { templateId };
}

/* ============================================
   CONSTRUCCI√ìN DEL OUTPUT COMPLETO (AGRUPADO)
   ============================================ */
function buildOutput(blocks, meta) {
    if (meta.selectedType === "record") {
        return buildRecordOutput(blocks, meta);
    } else if (meta.selectedType === "template") {
        return buildTemplateOutput(blocks, meta);
    } else if (meta.selectedType === "theme_prime") {
        return buildThemePrimeOutput(blocks, meta);
    }
    return buildGenericOutput(blocks, meta);
}

/* ======== RECORDS: AGRUPAR POR newId ======== */
function buildRecordOutput(blocks, meta) {
    const xmlLines = (meta.xmlOriginal || "").split("\n");
    const moduleName = (meta.moduleName || "").trim();

    const groups = {};
    const order = [];

    blocks.forEach(b => {
        const info = xmlLines.length ? findRecordMetaForBlock(b, xmlLines) : null;
        const underlyingModel = (info && info.underlyingModel) || "";
        const baseViewId = (info && info.recId) || b.viewName;
        const funcSuffix = b.func ? `_${b.func}` : "";
        const newId = `${baseViewId}${funcSuffix}`;
        const newName = b.func ? `${baseViewId}.${b.func}` : baseViewId;

        let inheritTargetId;
        if (baseViewId.includes(".")) {
            inheritTargetId = baseViewId;
        } else {
            inheritTargetId = moduleName ? `${moduleName}.${baseViewId}` : baseViewId;
        }

        const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

        if (!groups[newId]) {
            groups[newId] = {
                newId,
                newName,
                inheritTargetId,
                underlyingModel,
                items: []
            };
            order.push(newId);
        }

        groups[newId].items.push({
            actionType: b.actionType,
            exprEscaped,
            modification: b.modification
        });
    });

    let txt = "<odoo>\n";
    order.forEach(key => {
        const g = groups[key];
        txt += `    <record id="${g.newId}" model="ir.ui.view">\n`;
        txt += `        <field name="name">${g.newName}</field>\n`;
        if (g.underlyingModel) {
            txt += `        <field name="model">${g.underlyingModel}</field>\n`;
        }
        txt += `        <field name="inherit_id" ref="${g.inheritTargetId}"/>\n`;
        txt += `        <field name="arch" type="xml">\n`;

        g.items.forEach((it, idx) => {
            if (it.actionType === "hide") {
                txt += `            <xpath expr="${it.exprEscaped}" position="attributes">\n`;
                txt += `                <attribute name="invisible">1</attribute>\n`;
                txt += `            </xpath>\n`;
            } else {
                txt += `            <xpath expr="${it.exprEscaped}" position="after">\n`;
                txt += `                ${it.modification}\n`;
                txt += `            </xpath>\n`;
            }
            if (idx < g.items.length - 1) {
                txt += `\n`;
            }
        });

        txt += `        </field>\n`;
        txt += `    </record>\n\n`;
    });
    txt += "</odoo>\n";
    return txt;
}

/* ======== TEMPLATES: AGRUPAR POR newId ======== */
function buildTemplateOutput(blocks, meta) {
    const xmlLines = (meta.xmlOriginal || "").split("\n");
    const moduleName = (meta.moduleName || "").trim();

    const groups = {};
    const order = [];

    blocks.forEach(b => {
        const info = xmlLines.length ? findTemplateMetaForBlock(b, xmlLines) : null;
        const baseTemplateId = (info && info.templateId) || b.viewName;

        const funcSuffix = b.func ? `_${b.func}` : "";
        const newId = `${baseTemplateId}${funcSuffix}`;

        let inheritId;
        if (baseTemplateId.includes(".")) {
            inheritId = baseTemplateId;
        } else {
            inheritId = moduleName ? `${moduleName}.${baseTemplateId}` : baseTemplateId;
        }

        const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

        if (!groups[newId]) {
            groups[newId] = {
                newId,
                inheritId,
                items: []
            };
            order.push(newId);
        }

        groups[newId].items.push({
            actionType: b.actionType,
            exprEscaped,
            modification: b.modification
        });
    });

    let txt = "<odoo>\n";
    order.forEach(key => {
        const g = groups[key];
        txt += `    <template id="${g.newId}" inherit_id="${g.inheritId}">\n`;

        g.items.forEach((it, idx) => {
            if (it.actionType === "hide") {
                txt += `        <xpath expr="${it.exprEscaped}" position="attributes">\n`;
                txt += `            <attribute name="t-if">0</attribute>\n`;
                txt += `        </xpath>\n`;
            } else {
                txt += `        <xpath expr="${it.exprEscaped}" position="after">\n`;
                txt += `            ${it.modification}\n`;
                txt += `        </xpath>\n`;
            }
            if (idx < g.items.length - 1) {
                txt += `\n`;
            }
        });

        txt += `    </template>\n\n`;
    });
    txt += "</odoo>\n";
    return txt;
}

/* ======== THEME PRIME: AGRUPAR POR newId ======== */
function buildThemePrimeOutput(blocks, meta) {
    const moduleName = (meta.moduleName || "").trim();

    const groups = {};
    const order = [];

    blocks.forEach(b => {
        const viewNameBlock = (b.viewName || "").trim();
        const funcSuffix = b.func ? `_${b.func}` : "";
        const newId = `${viewNameBlock}${funcSuffix}`;

        let inheritKey;
        if (viewNameBlock.includes(".")) {
            inheritKey = viewNameBlock;
        } else {
            inheritKey = moduleName ? `${moduleName}.${viewNameBlock}` : viewNameBlock;
        }

        const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

        if (!groups[newId]) {
            groups[newId] = {
                newId,
                inheritKey,
                items: []
            };
            order.push(newId);
        }

        groups[newId].items.push({
            actionType: b.actionType,
            exprEscaped,
            modification: b.modification
        });
    });

    let txt = "<odoo>\n";
    order.forEach(key => {
        const g = groups[key];
        txt += `    <record id="${g.newId}" model="ir.ui.view">\n`;
        txt += `        <field name="name">${g.newId}</field>\n`;
        txt += `        <field name="inherit_id" search="[('key', '=', '${g.inheritKey}')]"/>\n`;
        txt += `        <field name="type">qweb</field>\n`;
        txt += `        <field name="key">${moduleName}.${g.newId}</field>\n`;
        txt += `        <field name="arch" type="xml">\n`;

        g.items.forEach((it, idx) => {
            if (it.actionType === "hide") {
                txt += `            <xpath expr="${it.exprEscaped}" position="attributes">\n`;
                txt += `                <attribute name="t-if">False</attribute>\n`;
                txt += `            </xpath>\n`;
            } else {
                txt += `            <xpath expr="${it.exprEscaped}" position="after">\n`;
                txt += `                ${it.modification}\n`;
                txt += `            </xpath>\n`;
            }
            if (idx < g.items.length - 1) {
                txt += `\n`;
            }
        });

        txt += `        </field>\n`;
        txt += `    </record>\n\n`;
    });
    txt += "</odoo>\n";
    return txt;
}

/* ======== SINGLE-BLOCK BUILDERS (para copiar bloque) ======== */
function buildRecordBlockXml(b, meta, xmlLines) {
    const moduleName = (meta.moduleName || "").trim();
    const info = xmlLines.length ? findRecordMetaForBlock(b, xmlLines) : null;
    const underlyingModel = (info && info.underlyingModel) || "";
    const baseViewId = (info && info.recId) || b.viewName;
    const funcSuffix = b.func ? `_${b.func}` : "";
    const newId = `${baseViewId}${funcSuffix}`;
    const newName = b.func ? `${baseViewId}.${b.func}` : baseViewId;

    let inheritTargetId;
    if (baseViewId.includes(".")) {
        inheritTargetId = baseViewId;
    } else {
        inheritTargetId = moduleName ? `${moduleName}.${baseViewId}` : baseViewId;
    }

    const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

    let txt = "";
    txt += `    <record id="${newId}" model="ir.ui.view">\n`;
    txt += `        <field name="name">${newName}</field>\n`;
    if (underlyingModel) {
        txt += `        <field name="model">${underlyingModel}</field>\n`;
    }
    txt += `        <field name="inherit_id" ref="${inheritTargetId}"/>\n`;
    txt += `        <field name="arch" type="xml">\n`;

    if (b.actionType === "hide") {
        txt += `            <xpath expr="${exprEscaped}" position="attributes">\n`;
        txt += `                <attribute name="invisible">1</attribute>\n`;
        txt += `            </xpath>\n`;
    } else {
        txt += `            <xpath expr="${exprEscaped}" position="after">\n`;
        txt += `                ${b.modification}\n`;
        txt += `            </xpath>\n`;
    }

    txt += `        </field>\n`;
    txt += `    </record>`;
    return txt;
}

function buildTemplateBlockXml(b, meta, xmlLines) {
    const moduleName = (meta.moduleName || "").trim();
    const info = xmlLines.length ? findTemplateMetaForBlock(b, xmlLines) : null;
    const baseTemplateId = (info && info.templateId) || b.viewName;
    const funcSuffix = b.func ? `_${b.func}` : "";
    const newId = `${baseTemplateId}${funcSuffix}`;

    let inheritId;
    if (baseTemplateId.includes(".")) {
        inheritId = baseTemplateId;
    } else {
        inheritId = moduleName ? `${moduleName}.${baseTemplateId}` : baseTemplateId;
    }

    const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

    let txt = "";
    txt += `    <template id="${newId}" inherit_id="${inheritId}">\n`;

    if (b.actionType === "hide") {
        txt += `        <xpath expr="${exprEscaped}" position="attributes">\n`;
        txt += `            <attribute name="t-if">0</attribute>\n`;
        txt += `        </xpath>\n`;
    } else {
        txt += `        <xpath expr="${exprEscaped}" position="after">\n`;
        txt += `            ${b.modification}\n`;
        txt += `        </xpath>\n`;
    }

    txt += `    </template>`;
    return txt;
}

function buildThemePrimeBlockXml(b, meta, xmlLines) {
    const moduleName = (meta.moduleName || "").trim();
    const viewNameBlock = (b.viewName || "").trim();
    const funcSuffix = b.func ? `_${b.func}` : "";
    const newId = `${viewNameBlock}${funcSuffix}`;

    let inheritKey;
    if (viewNameBlock.includes(".")) {
        inheritKey = viewNameBlock;
    } else {
        inheritKey = moduleName ? `${moduleName}.${viewNameBlock}` : viewNameBlock;
    }

    const exprEscaped = (b.xpath || "").replace(/"/g, "&quot;");

    let txt = "";
    txt += `    <record id="${newId}" model="ir.ui.view">\n`;
    txt += `        <field name="name">${newId}</field>\n`;
    txt += `        <field name="inherit_id" search="[('key', '=', '${inheritKey}')]"/>\n`;
    txt += `        <field name="type">qweb</field>\n`;
    txt += `        <field name="key">your_module.${newId}</field> <!-- TODO: sustituye 'your_module' por tu m√≥dulo -->\n`;
    txt += `        <field name="arch" type="xml">\n`;

    if (b.actionType === "hide") {
        txt += `            <xpath expr="${exprEscaped}" position="attributes">\n`;
        txt += `                <attribute name="t-if">False</attribute>\n`;
        txt += `            </xpath>\n`;
    } else {
        txt += `            <xpath expr="${exprEscaped}" position="after">\n`;
        txt += `                ${b.modification}\n`;
        txt += `            </xpath>\n`;
    }

    txt += `        </field>\n`;
    txt += `    </record>`;
    return txt;
}

/* ======== FALLBACK GEN√âRICO ======== */
function buildGenericBlockXml(b) {
    let txt = "";
    txt += `--- BLOQUE ${b.index} ---\n`;
    txt += `Vista: ${b.viewName}\n`;
    txt += `Funcionalidad: ${b.func}\n`;
    txt += `Acci√≥n: ${b.actionType}\n`;
    txt += `Fragmento: ${b.fragment}\n`;
    txt += `XPath: ${b.xpath}\n`;
    txt += `Modificaci√≥n:\n${b.modification}`;
    return txt;
}

function buildGenericOutput(blocks, meta) {
    let txt = "";
    blocks.forEach(b => {
        txt += buildGenericBlockXml(b) + "\n\n";
    });
    return txt;
}

/* ============================================
   DESCARGA (VALIDA CAMPOS OBLIGATORIOS)
   ============================================ */
function downloadResults() {
    clearError();

    if (!selectedType) {
        showError("Debes seleccionar un tipo de vista (Template, Records o Theme Prime).");
        return;
    }

    const xmlOriginal = document.getElementById("xmlOriginal").value;
    const moduleName = document.getElementById("moduleName").value.trim();
    const outputFilename = document.getElementById("outputFilename").value.trim();

    if (!moduleName) {
        showError("El campo 'M√≥dulo de la vista original' es obligatorio.");
        return;
    }
    if (!xmlOriginal.trim()) {
        showError("Debes pegar el XML original de la vista.");
        return;
    }

    const blocks = collectBlocks();
    if (!blocks.length) {
        showError("Debes crear al menos un bloque.");
        return;
    }

    const missingBlock = blocks.find(b => !b.viewName);
    if (missingBlock) {
        const label = missingBlock.label ? ` (${missingBlock.label})` : "";
        showError(
            `El bloque ${missingBlock.index}${label} no tiene 'Nombre de la vista (este bloque)'. ` +
            `Pulsa 'Generar XPath' para intentar autocompletarlo o rell√©nalo manualmente.`
        );
        return;
    }

    let filename = outputFilename || "views.xml";
    if (!filename.toLowerCase().endsWith(".xml")) {
        filename += ".xml";
    }

    const meta = {
        selectedType,
        xmlOriginal,
        moduleName
    };

    const txt = buildOutput(blocks, meta);

    const blob = new Blob([txt], { type: "text/xml" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
